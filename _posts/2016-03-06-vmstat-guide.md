---
layout: post
title: vmstat
---
http://linuxcommand.org/man_pages/vmstat8.html
vmstat  reports  information about processes, memory, paging, block IO,traps, and cpu activity.
The first report produced gives averages since the last reboot.   Addi-tional  reports  give information on a sampling period of length delay.
The process and memory reports are instantaneous in either case.

```bash
[root@localhost ~]# vmstat 1 10
procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 2  0      0 6499884  13184 1135684    0    0     0    32 18155 30201  0 15 85  0  0
 2  0      0 6499512  13184 1136036    0    0     0     0 20257 33626  0 16 84  0  0
 3  0      0 6498768  13184 1136508    0    0     0     0 19495 31016  0 16 84  0  0
 1  0      0 6498644  13184 1136880    0    0     0     0 19664 31900  0 11 89  0  0
 0  0      0 6498148  13184 1137356    0    0     0     0 19916 33392  0 14 86  0  0
 0  0      0 6497652  13192 1137832    0    0     0    12 20043 32998  0 16 84  0  0
 2  0      0 6497156  13192 1138176    0    0     0     0 20537 32858  0 14 85  0  0
 2  0      0 6496784  13192 1138656    0    0     0     0 19350 31600  0  9 91  0  0
 0  0      0 6496536  13192 1139004    0    0     0     0 17175 28939  0 12 88  0  0
 3  0      0 6495792  13192 1139476    0    0     0     0 20208 33089  0 16 84  0  0
```

**Procs**
* r：等待运行时间片的进程数。
* b：等待资源的进程数。如等待IO、内存交换等。

**Memory**
* swpd：使用的虚拟内存量大小（以k为单位）。
* free：空闲内存大小。
* buff：缓冲区内存大小。
* cache：cache的内存大小。
* inact：非活动内存大小。（-a选项）
* active：活动内存大小。（-a选项）

**Swap**
* si：每秒从交换区写入到物理内存的数据量。
* so：每秒从物理内存写入到交换区的数据量。

**IO**
* bi：读取块设备的数据量（KB/秒）。
* bo：写入块设备的数据量（KB/秒）。

**System**
* in：每秒中断数，包括时钟中断。
* cs：每秒的上下文切换的数量。

**CPU**
这些是总的处理器时间的占用百分比。
* us：非内核代码运行时间。（用户时间）
* sy：内核代码运行时间。（系统时间）
* id：空闲时间。Linux 2.5.41之前，该项包含了IO等待时间。
* wa：等待IO时间。Linux 2.5.41之前，包含在了空闲时间里。
* st：虚拟机盗取的时间。Linux 2.6.11之前，该值未知。

关于CPU，如果r长时间大于core数，则表明cpu可能负载可能较高，如果在结合us长期50%以上，那么就要考虑优化用户代码或者增加cpu。
等待IO的线程数，如果长期大于1需要分析具体情况，是否存在内存或磁盘的瓶颈。

关于内存，如果swpd持续为0，则表示物理内存足够使用，不存在内存不足的情况；又或者swpd很大，但是si和so长时间为0，说明swpd里都是最近很少使用的数据，此时内存状况也属于正常。
如果free+buff+cache>物理内存的70%，也许系统现在仍然是正常的，但是要准备好优化或扩容的计划，否则内存细微的波动就可能导致业务故障。

关于IO，4k随机读写比较符合程序大部分业务情况（日志服务器等除外），7200转的机械磁盘，4k随机读写均在2.2MB/秒；而SSD差距就比较大，普遍4k随机读20MB/秒以上，而4k随机写普遍在80MB/秒以上。
参照7200转机械硬盘，如bi或bo长时间大于1MB，则说明业务是磁盘io型，cpu的wa占比也会相应较大。若超过2MB，则说明此时磁盘可能已经成为瓶颈，需要准备做相对应的优化或硬件升级。

关于CPU，wa越小越好，表示系统IO（磁盘IO、网卡IO等）很健康，反之；id越小表示cpu越空闲，系统没有问题但是存在资源浪费，我所在的公司99%的服务器都是该情况。
一个合理利用资源的健康系统，应该是us+sy高，而id+wa低。那us+sy的上限在哪？这个可能每个公司、每个程序员都有不同的见解，个人建议不要超70%。
突然发现自己特别热衷70%，无论是内存、CPU还是网卡，尽量不用让使用长时间超70%，当然瞬时的是可以接受的。

参见：
iostat(1), sar(1), mpstat(1), ps(1), top(1), free(1)






